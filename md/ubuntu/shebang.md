# shebang

### 2015-12-18 Fri

- shebang というものがある。スクリプトファイルの 1 行目にしばしば書かれるもののことである。特にそのうちの「#!」という文字列のことである。
- shebang という言葉は、語源が明らかでないらしい。ただし bang が ! を指すのは明らかである。hashbang と呼ばれることもあって、これは語源もなにもなく文字の名称なので、わかりやすい気がする。しかし、hashbang と言うと、URL における別の利用を指す場合があるようだ。
- Unix 系 OS においては、各プログラムの起動において汎用される、loader というプログラムがある。普通、loader に対しては、機械語のファイルが渡され、loader はそれを実行する。ただしもし、ファイルの先頭データが ASCII コードにおける（その OS の標準的な文字エンコーディングにおける？） "#!" であった場合、1 行目を参考にプログラムを選択し、2 行目以降をそれに与える。例えば、あるインタープリタに、あるスクリプトファイルを与えることができる。
- 言い換えると、shebang を解釈しているのは text shell ではない。例えば bash で ./example.sh とした時、bash shell が行っているのは、このファイルを実行せよ、と OS に指示しているだけである。指示された OS が、ファイル先頭の 2 文字を読んで、判断する。shebang は 16 進数で 23 と 21 である。
- インタープリタ、すなわちプログラムは、#!/bin/sh などとフルパスで指定される。そしてスクリプトのパスが例えば ~/example.sh だった場合、コマンドラインで /bin/sh ~/example.sh と実行したのと同じことになる。つまり、スクリプトファイルのフルパスが第 1 引数として渡される。
- 言い換えると、/bin/sh < ~/example.sh と実行したのと同じことになるわけではない。つまり、プログラム /bin/sh に渡されるデータは、標準入力によるのではなく、コマンドライン引数による。プログラムが、与えられたパスのファイルを開きたければ、開く。
- また、開いたファイルには当然に 1 行目の shebang 行も含まれているが、それをどう扱うかは、受け取ったプログラムの自由である。多くのインタープリタでは、# から始まる行をコメントとして無視するが、インタープリタに shebang の行が渡されていないわけではない。
- 例えば、次のコードは有効である。

```
#!/bin/cat
hello, world
```

- このファイルが ~/example.txt だったとしよう。すると、コマンドラインで ~/example.txt として実行することは、コマンドラインで /bin/cat ~/example.txt とすることと同じである。そして、cat コマンドは # で始まる行を無視することをしないため、この全体が出力される。
- 渡されるのがファイルのパスに過ぎないことも確認できる。例えば、あらゆる環境で動作するかわからないが、shebang を単に #!/bin/ls や #!/bin/ls -l としたファイルを実行すると、ls ~/example.txt や ls -l ~/example.txt が実行され、ファイルの情報が表示されるだけであって、ファイルの内容は読まれない。
- しかし、shebang においていわゆる普通のスクリプトインタープリタ以外のプログラムを呼び出すのは、実用性はないだろう。

# env

- env というプログラムがある。
- shebang で、#!/usr/bin/env sh といった形でよく使われる。
- もし、shebang で #!/bin/sh とすると、sh がそこになく別のパスにあった場合に動かない。env を使った形で書くと、ユーザの環境変数 PATH から、sh というプログラムを探して使ってくれる。
- 何が動作するか曖昧になるが、様々な環境で動作しやすくなる。
- env コマンドへのオプションは、与えるコマンド名より先に渡すので、与えるコマンドに引数を渡すこともできる。
- 環境変数 PATH を参考にしているだけであるから、例えば ~/example ディレクトリに、interpreter という実行ファイルと script というスクリプトを作って、script の shebang に #!/usr/bin/env interpreter と書き、~/example を環境変数 PATH に加えることで interpreter へのパスを通したならば、コマンドラインで ~/example/script などとスクリプトを直接実行することで、interpreter が起動され、第 1 引数にはスクリプトの位置 ~/example/script が渡される。
- もし、shebang というものが仮に、#!sh などとしただけで自動的に環境変数 PATH を探すのであったなら、env というプログラムを通す必要はほとんどなかったろう。しかし、そうではないので、広く使われている。フルパスは / から始まるので、相対パスと混ぜても表記に混乱はない気がするが、そもそも環境変数 PATH はシェルに属しているので、OS の命令が考慮すべきものではないということかもしれない。
- 例えば env を使った時、env への引数、env へ渡すコマンドの引数、スクリプトが起動された際の引数というものがあると思うが、どんな感じの処理になっているのかよくわかっていない。







